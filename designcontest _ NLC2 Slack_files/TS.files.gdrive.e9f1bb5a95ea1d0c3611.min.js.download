webpackJsonp([412],{3871:function(e,r){(function(){"use strict";TS.registerModule("files.gdrive",{onStart:function e(){if(!TS.client)return;TS.files.team_file_shared_sig.add(S)},openPickerWindow:function r(){var t=null;return new Promise(function(r,a){var l=TS.utility.window.open({url:e,try_window_open_in_ssb:true,height:n});if(!l){a(new Error("could not open window"))}t=o(r,a);window.addEventListener("message",t);if(i){a("Promise already made")}i=true}).then(function(e){i=false;return u(e.chosen_files,TS.shared.getActiveModelOb())}).catch(function(e){if(e==="Promise already made"){return}var r=a;var t=TS.shared.getActiveModelOb();TS.error(e);if((e.data.error==="unidentified_external_url"||e.data.error==="file_type_has_no_handler")&&e.args.link){r=TS.i18n.t("We don’t currently support importing that type of Google Drive file, but we included the link so that others can access it.","files")();v(t.id,e.args.link)}if(e.data.error==="filename_too_long"){r=l}TS.client.ui.addEphemeralBotMsg({text:r,ephemeral_type:"file_type_has_no_handler",slackbot_feels:"sad_surprise"});i=false}).finally(function(){window.removeEventListener("message",t)})},createAndShare:function e(r,t){return m(r,t).then(function(e){TS.files.gdrive.create(r,e)}).catch(function(){TS.menu.file.onGDriveCreateComplete(false)})},create:function e(r,n){if(n&&n.channel){var i=TS.channels.getChannelById(n.channel);if(i&&i.name){TS.channels.join(i.name,false)}else if(TS.ims.getImByMemberId(n.channel)){TS.ims.startImByMemberId(n.channel)}else if(TS.mpims.getMpimById(n.channel)){TS.mpims.displayMpim({id:n.channel})}else if(TS.groups.getGroupById(n.channel)){TS.groups.displayGroup({id:n.channel})}else{TS.error("no valid shared channel/im/mpim/group to display")}}return TS.api.call("files.createExternal",{service_stub:"gdrive",mime_type:t+"."+r,filename:n.title||"",open_edit:!!n.channel}).then(function(e){TS.utility.window.alwaysOpenInBrowser(e.data.url);if(n&&n.channel){p(e.data.url,n.channel,n.comment)}TS.menu.file.onGDriveCreateComplete(true,e)}).catch(function(e){TS.menu.file.onGDriveCreateComplete(false);var t=a;if(e.data.error==="use_auth_url"){return f(r,n)}if(e.data.error==="filename_too_long"){t=l}TS.error(e);TS.client.ui.addEphemeralBotMsg({text:t,ephemeral_type:"unhandled_gdrive_create",slackbot_feels:"sad_surprise"})})}});var e=TS.boot_data.team_url+"files/import/gdrive";var r=TS.boot_data.team_url+"files/create/gdrive/auth";var t="application/vnd.google-apps";var n=675;var i=false;var a=TS.i18n.t("Darn, that didn’t work. Try again or <https://my.slack.com/help/requests/new|contact us> if it’s still not working.","files")();var l=TS.i18n.t("Sorry! The name of that file is too long for us to handle. Please try importing a file with a shorter filename.","files")();var o=function e(r,t){return c({resolve:r,reject:t,method:"gdrive_picker"})};var s=function e(r,t){return c({resolve:r,reject:t,method:"google_auth"})};var c=function e(r){return function(e){if(e.data.method!==r.method)return;if(!e.data.ok){r.reject(new Error(r.method+" not ok"))}else{r.resolve(e.data)}}};var u=function e(r,t){var n=r.map(function(e){return d(e,t)});return Promise.all(n)};var d=function e(r,t){return TS.api.call("files.uploadExternal",{channels:t.id,link:r.url}).then(function(e){if(t.user&&TS.ims.getImByMemberId(t.user)&&TS.model.team.enterprise_id){v(t.id,e.data.file.url_private,true,true)}})};var f=function e(t,i){var a=null;return new Promise(function(e,t){var i=TS.utility.window.open({url:r,try_window_open_in_ssb:true,height:n});if(!i){t(new Error("could not open window"))}a=s(e,t);window.addEventListener("message",a)}).then(function(){return TS.files.gdrive.create(t,i)}).catch(function(e){TS.error(e)}).finally(function(){window.removeEventListener("message",a)})};var m=function e(r,n){return new Promise(function(e,i){var a={type:t+r,display_type:n};var l=TS.templates.builders.buildFileSharingControls(a,false,false,true,null);var o=TS.i18n.t("Create a Google {gdrive_type}","files")({gdrive_type:_.capitalize(n)});TS.generic_dialog.start({title:o,body:TS.templates.gdrive_create_dialog({sharing_html:new Handlebars.SafeString(l)}),show_cancel_button:true,esc_for_ok:false,fullscreen:false,go_button_text:TS.i18n.t("Create","files")(),type:"overflow_visible",onGo:function r(){e(h())},onCancel:i});$("#share_cb").removeAttr("checked");TS.ui.file_share.bindFileShareDropdowns();TS.ui.file_share.bindFileShareShareToggle();TS.ui.file_share.bindFileShareCommentField();TS.ui.comments.bindInput($("#file_comment_textarea"),function(){e(h)})})};var h=function e(){return{title:_.trim($("#document_title").val())||TS.i18n.t("Untitled","files")(),comment:_.trim(TS.utility.contenteditable.value($("#file_comment_textarea"))),channel:$("#share_cb").is(":checked")?$("#share_model_ob_id").val():false}};var p=function e(r,t,n){var i=false;if(TS.ims.getImByMemberId(t)){i=true}return TS.api.call("files.uploadExternal",{link:r,channels:i?"":t}).then(function(e){if(i){v(t,e.data.file.url_private,true,true)}if(n){TS.api.call("files.comments.add",{file:e.data.file.id,comment:n,channel:t})}}).catch(function(e){TS.error(e);TS.client.ui.addEphemeralBotMsg({text:TS.i18n.t("Oh no! I couldn’t import your newly created file","files")(),ephemeral_type:"gdrive_share_file_error",slackbot_feels:"sad_surprise"})})};var v=function e(r,t,n,i){TS.api.call("chat.postMessage",{channel:r,text:t,unfurl_links:n||false,unfurl_media:i||false}).catch(function(e){TS.error(e)})};var S=function e(r){if(_.get(r,"external_type")!=="gdrive")return;if(_.get(r,"user")!==TS.model.user.id)return;if(!TS.model.team.prefs.gdrive_enabled_team)return;if(TS.model.prefs.seen_gdrive_coachmark)return;TS.coachmark.start(TS.coachmarks.coachmarks.gdrive);TS.model.prefs.seen_gdrive_coachmark=true;TS.prefs.setPrefByAPI({name:"seen_gdrive_coachmark",value:true})}})()}},[3871]);